# Contributing to This Configuration

## Adding a New System

1. **Create system directory:**
   ```bash
   mkdir -p systems/my-system/homes/chris
   ```

2. **Generate hardware configuration:**
   ```bash
   nixos-generate-config --root /mnt --show-hardware-config > systems/my-system/hardware-configuration.nix
   ```

3. **Create system configuration** (see `EXAMPLE-new-system.nix`):
   ```nix
   { config, pkgs, ... }:
   {
     imports = [
       ../../modules/common          # All common settings
       ../../modules/hardware/laptop.nix  # If it's a laptop
       ../../modules/users/chris.nix
       ./hardware-configuration.nix
       ../../desktops/gnome.nix      # Your preferred DE
     ];
     
     networking.hostName = "my-system";
     networking.hostId = "########";  # Generate with: head -c 8 /etc/machine-id
     system.stateVersion = "24.11";
   }
   ```

4. **Create home-manager configuration:**
   ```bash
   cat > systems/my-system/homes/chris/home.nix << 'EOF'
   { config, pkgs, ... }:
   {
     imports = [
       ../../../../homes/chris/common.nix
       # Add desktop-specific config if needed
     ];
   }
   EOF
   ```

5. **Add to flake.nix:**
   ```nix
   "my-system" = nixpkgs.lib.nixosSystem {
     system = "x86_64-linux";
     modules = [
       ./systems/my-system/configuration.nix
       home-manager.nixosModules.home-manager
       {
         home-manager.useGlobalPkgs = true;
         home-manager.useUserPackages = true;
         home-manager.users.chris = import ./systems/my-system/homes/chris/home.nix;
         home-manager.extraSpecialArgs = { inherit inputs; };
       }
     ];
   };
   ```

## Modifying Modules

### Adding a Common Setting

If you find yourself adding the same configuration to multiple systems:

1. Add it to an existing module in `modules/common/`, or
2. Create a new module if it's a distinct concern

Example - adding a new common package:
```nix
# modules/common/packages.nix
environment.systemPackages = with pkgs; lib.mkDefault [
  htop
  gnupg
  your-new-package  # Add here
];
```

### Creating a New Module

1. Create the module file:
   ```bash
   cat > modules/common/myfeature.nix << 'EOF'
   { config, lib, pkgs, ... }:
   {
     # Your configuration here
     # Use lib.mkDefault for values that can be overridden
   }
   EOF
   ```

2. Add import to `modules/common/default.nix`:
   ```nix
   imports = [
     # ... existing imports ...
     ./myfeature.nix
   ];
   ```

## Module Design Principles

1. **Use `lib.mkDefault`** for values that systems might want to override
2. **Keep modules focused** - one concern per module
3. **Document the module** with comments explaining its purpose
4. **Test changes** on at least one system before committing

## Directory Structure

```
modules/
├── common/          # Settings shared by all/most systems
├── hardware/        # Hardware-specific profiles (laptop, desktop, server)
└── users/           # User account definitions

systems/
├── <system-name>/
│   ├── configuration.nix           # System-specific config
│   ├── hardware-configuration.nix  # Generated by nixos-generate-config
│   ├── filesystems.nix            # Optional: filesystem config
│   └── homes/chris/
│       └── home.nix               # Home-manager config for this system

desktops/            # Desktop environment modules
homes/chris/         # Shared home-manager configurations
```

## Best Practices

1. **Start with the example** - Use `EXAMPLE-new-system.nix` as a template
2. **Keep system configs minimal** - Only include what's unique to that system
3. **Use modules for common settings** - Don't duplicate configuration
4. **Comment your changes** - Especially for system-specific quirks
5. **Test before pushing** - Build the configuration locally first

## Testing Changes

```bash
# Build without switching
sudo nixos-rebuild build --flake .#my-system

# Test in a VM
nixos-rebuild build-vm --flake .#my-system
./result/bin/run-my-system-vm

# Switch to the new configuration
sudo nixos-rebuild switch --flake .#my-system
```
